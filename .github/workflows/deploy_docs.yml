# Simple workflow for deploying static content to GitHub Pages
name: Deploy DocC

on:
  # Runs on new releases
  release:
    types: [published]
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write

# Allow one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: macos-13
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v3
      - name: Setup Xcode Project
        run: |
          sh -e doc_gen/dl_framework.sh
          sh -e doc_gen/move_header_files.sh AgoraRtcKit.xcframework AgoraRtcKit.docc
          sh -e doc_gen/headers_to_xcodeproj.sh AgoraRtcKit docc_builder
      - name: Clone Python Script
        uses: actions/checkout@v3
        with:
          repository: littleGnAl/iris-doc
          path: iris-doc
      - name: Set up python 3.9
        uses: actions/setup-python@v4
        with:
            python-version: '3.9'
      - name: Run Python Script (CN)
        run: |
          cd iris-doc
          python -m pip install -r requirements.txt
          python iris_doc.py \
            --config=$(pwd)/fmt_config/fmt_oc.yaml \
            --language=oc \
            --template-url=https://github.com/AgoraIO/agora_doc_source/releases/download/master-build/ios_ng_json_template_cn.json \
            --export-file-path=$(pwd)/../docc_builder/AgoraRtcKit/Headers/AgoraRtcKit.h
      - name: Generate DocC Archive (CN)
        run: xcodebuild -project docc_builder/AgoraRtcKit.xcodeproj docbuild -scheme AgoraRtcKit -derivedDataPath /tmp/docbuild -destination generic/platform=iOS
      - name: Zip It Up (CN)
        run: |
          mv /tmp/docbuild/Build/Products/Debug-iphoneos/AgoraRtcKit.doccarchive AgoraRtcKit-cn.doccarchive
          zip -r AgoraRtcKit-cn.doccarchive.zip AgoraRtcKit-cn.doccarchive
      - name: Upload DocC Artifact (CN)
        uses: actions/upload-artifact@v3
        with:
          name: AgoraRtcKit-cn.doccarchive.zip
          path: AgoraRtcKit-cn.doccarchive.zip
      - name: Upload DocC Archive to GitHub release (CN)
        if: ${{ github.event.release }}
        uses: svenstaro/upload-release-action@2.6.0
        with:
          file: AgoraRtcKit-cn.doccarchive.zip
          asset_name: AgoraRtcKit-cn.doccarchive.zip
          tag: ${{ github.ref_name }}
      - name: Run Python Script (EN)
        run: |
          cd iris-doc
          python iris_doc.py \
            --config=$(pwd)/fmt_config/fmt_oc.yaml \
            --language=oc \
            --template-url=https://github.com/AgoraIO/agora_doc_source/releases/download/master-build/ios_ng_json_template_en.json \
            --export-file-path=$(pwd)/../docc_builder/AgoraRtcKit/Headers/AgoraRtcKit.h
      - name: Generate DocC Archive (EN)
        run: xcodebuild -project docc_builder/AgoraRtcKit.xcodeproj docbuild -scheme AgoraRtcKit -derivedDataPath /tmp/docbuild -destination generic/platform=iOS
      - name: Zip It Up (EN)
        run: |
          mv /tmp/docbuild/Build/Products/Debug-iphoneos/AgoraRtcKit.doccarchive AgoraRtcKit-en.doccarchive
          zip -r AgoraRtcKit-en.doccarchive.zip AgoraRtcKit-en.doccarchive
      - name: Upload DocC Artifact (EN)
        uses: actions/upload-artifact@v3
        with:
          name: AgoraRtcKit-en.doccarchive.zip
          path: AgoraRtcKit-en.doccarchive.zip
      - name: Upload DocC Archive to GitHub release (EN)
        if: ${{ github.event.release }}
        uses: svenstaro/upload-release-action@2.6.0
        with:
          file: AgoraRtcKit-en.doccarchive.zip
          asset_name: AgoraRtcKit-en.doccarchive.zip
          tag: ${{ github.ref_name }}
      - name: Build Static Website
        if: ${{ github.event.release.prerelease == false && github.event.release.draft == false && github.event.release.tag_name == github.event.repository.default_branch }}
        run: |
          $(xcrun --find docc) process-archive \
            transform-for-static-hosting AgoraRtcKit-en.doccarchive \
            --hosting-base-path AgoraRtcEngine_iOS \
            --output-path docs
          echo "<script>window.location.href += \"/documentation/agorartckit\"</script>" > docs/index.html

      - name: Upload artifact
        if: ${{ github.event.release.prerelease == false && github.event.release.draft == false && github.event.release.tag_name == github.event.repository.default_branch }}
        uses: actions/upload-pages-artifact@v1
        with:
          # Upload docs directory
          path: 'docs'

      - name: Deploy to GitHub Pages
        if: ${{ github.event.release.prerelease == false && github.event.release.draft == false && github.event.release.tag_name == github.event.repository.default_branch }}
        id: deployment
        uses: actions/deploy-pages@v1
